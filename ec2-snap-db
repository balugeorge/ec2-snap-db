#!/bin/bash
#set -x

die() { echo "$@" 1>&2; exit 1; }

if [ -z "$AWS_ACCESS_KEY" ]; then
  die "Missing AWS_ACCESS_KEY"
fi

if [ -z "$AWS_SECRET_KEY" ]; then
  die "Missing AWS_SECRET_KEY"
fi

if [ $# -eq 0 ]; then
  die "Usage: $0 MOUNT [MOUNT...]"
fi

eval `./ec2-instance-env`

VOLUME_MAP=$(./ec2-volumes-for-mount "$@")
if [ $? -ne 0 ]; then
  echo "Could not determine volumes for mounts: $@" 1>&2
  exit 1
fi

FREEZE=$(awk -F: '{ print "--freeze " $1 }' <<< "$VOLUME_MAP" | uniq)
VOLUMES=$(awk -F: '{ print $2 }' <<< "$VOLUME_MAP")
echo ec2-consistent-snapshot --noaction --region $AWS_REGION $FREEZE $VOLUMES
